# Created by: ijliao

PORTNAME=	hdf5
PORTVERSION=	1.12.0
PORTEPOCH=	1
CATEGORIES=	wip science archivers graphics
MASTER_SITES=	https://support.hdfgroup.org/ftp/HDF5/releases/hdf5-${PORTVERSION:R}/hdf5-${PORTVERSION}/src/
DISTNAME=	CMake-${PORTNAME}-${PORTVERSION}

MAINTAINER=	sunpoet@FreeBSD.org
COMMENT=	Hierarchical Data Format library (from NCSA) (latest)

LICENSE=	BSD4CLAUSE
LICENSE_FILE=	${WRKSRC}/COPYING

USES=		cmake compiler:c11 localbase perl5
USE_PERL5=	build

CONFLICTS_INSTALL=	hdf-4.[0-9]* hdf5-1.6.[0-9]*

OPTIONS_DEFINE=	DEBUG EXAMPLES FORTRAN SZIP
OPTIONS_RADIO=	SUPPORT
OPTIONS_RADIO_SUPPORT=	CXX PARALLEL
OPTIONS_DEFAULT=CXX FORTRAN SZIP
OPTIONS_SUB=	yes
PARALLEL_DESC=	Parallel support

WRKSRC_SUBDIR=	${PORTNAME}-${PORTVERSION}
CMAKE_ON=	HDF5_BUILD_HL_LIB		\
		HDF5_ENABLE_INSTRUMENT		\
		HDF5_BUILD_TOOLS		\
		HDF5_STRICT_FORMAT_CHECKS
CMAKE_ARGS=	-DHDF5_INSTALL_INCLUDE_DIR:PATH=${PREFIX}/include	\
		-DDEFAULT_API_VERSION="v110"
EXAMPLESVER=	1.12.6
TEST_TARGET=	test
USE_LDCONFIG=	yes

DATASTUFF=	RELEASE.txt			\
		USING_HDF5_CMake.txt
DATASTUFFEX=	CTestScript.cmake		\
		HDF5_Examples.cmake		\
		HDF5_Examples_options.cmake	\
		USING_CMake_Examples.txt
PKGCFGDIR=	${PREFIX}/libdata/pkgconfig
PKGCFG=		hdf5.pc hdf5_hl.pc
PKGCFGCXX=	hdf5_cpp.pc hdf5_hl_cpp.pc
PKGCFGFC=	hdf5_fortran.pc

PORTEXAMPLES=	*

CXX_CMAKE_BOOL=		HDF5_BUILD_CPP_LIB
CXX_VARS=		PKGCFG+="${PKGCFGCXX}"
EXAMPLES_CMAKE_BOOL=	HDF5_BUILD_EXAMPLES HDF5_TEST_EXAMPLES HDF5_PACK_EXAMPLES
EXAMPLES_VARS=		DATASTUFF+="${DATASTUFFEX}"
FORTRAN_CMAKE_BOOL=	HDF5_BUILD_FORTRAN
FORTRAN_CONFIGURE_ENV=	F9X=${FC}
FORTRAN_USES=		fortran
FORTRAN_VARS=		PKGCFG+="${PKGCFGFC}"
PARALLEL_IMPLIES=	FORTRAN
PARALLEL_CMAKE_BOOL=	HDF5_ENABLE_PARALLEL
PARALLEL_VARS=		FCFLAGS+=-I${LOCALBASE}/include
PARALLEL_LDFLAGS=	-L${LOCALBASE}/lib -lmpifort -lmpi
PARALLEL_LIB_DEPENDS=	libmpi.so:net/mpich
SZIP_CMAKE_BOOL=	HDF5_ENABLE_SZIP_SUPPORT
SZIP_LIB_DEPENDS=	libsz.so:science/szip

.include <bsd.port.options.mk>

post-extract-EXAMPLES-on:
	(cd ${WRKSRC} && ${TAR} xfz ../HDF5Examples-${EXAMPLESVER}-Source.tar.gz)

pre-build-EXAMPLES-on:
	${MKDIR} ${WRKDIR}/.build
	${CP} -R ${WRKSRC}/HDF5Examples ${WRKDIR}/.build

post-stage:
	${RM} ${STAGEDIR}${PREFIX}/share/COPYING
	${MKDIR} ${STAGEDIR}${DATADIR}
	(cd ${STAGEDIR}${PREFIX}/share && ${MV} ${DATASTUFF} ${STAGEDIR}${DATADIR}/)
.for pk in ${PKGCFG}
	${LN} -sf ${pk:C/5/5${PKGNAMESUFFIX}/:C/.pc/-${PORTVERSION}.pc/}	\
		${STAGEDIR}${PKGCFGDIR}/${pk}
.endfor

post-stage-EXAMPLES-on:
	${MV} ${STAGEDIR}${PREFIX}/share/HDF5Examples ${STAGEDIR}${EXAMPLESDIR}

.include <bsd.port.mk>
